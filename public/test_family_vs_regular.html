<!DOCTYPE html>
<html>
<head>
    <title>Family vs Regular Comparison Test</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .result-box { 
            border: 2px solid #ddd; 
            border-radius: 10px; 
            padding: 15px; 
            background: #f9f9f9;
        }
        .result-box h3 { margin-top: 0; }
        .feature-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            margin: 10px 0;
        }
        .feature-item {
            background: white;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .feature-name { font-size: 12px; color: #666; }
        .feature-score { font-size: 16px; font-weight: bold; color: #7c3aed; }
        button { 
            padding: 10px 20px; 
            font-size: 16px; 
            cursor: pointer;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 5px;
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .similarity-big {
            font-size: 48px;
            font-weight: bold;
            color: #7c3aed;
            text-align: center;
            margin: 20px 0;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px;
        }
        .status.error { background: #fee; color: #c00; }
        .status.success { background: #efe; color: #060; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Family Similarity vs Regular Comparison Test</h1>
        
        <div>
            <input type="file" id="parentFile" accept="image/*">
            <label for="parentFile">Parent Image</label>
        </div>
        <div>
            <input type="file" id="childFile" accept="image/*">
            <label for="childFile">Child Image</label>
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="runComparison()">üöÄ Run Both Comparisons</button>
            <button onclick="clearResults()">Clear</button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div class="comparison">
            <div class="result-box">
                <h3>ü§ñ Regular Face Comparison</h3>
                <div id="regularResult">
                    <p style="color: #999;">Upload images and click Run</p>
                </div>
            </div>
            
            <div class="result-box">
                <h3>üë®‚Äçüë©‚Äçüë¶ Family Similarity Analysis</h3>
                <div id="familyResult">
                    <p style="color: #999;">Upload images and click Run</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        async function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
            });
        }
        
        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isError ? 'error' : 'success');
            status.style.display = 'block';
        }
        
        function clearResults() {
            document.getElementById('regularResult').innerHTML = '<p style="color: #999;">Upload images and click Run</p>';
            document.getElementById('familyResult').innerHTML = '<p style="color: #999;">Upload images and click Run</p>';
            document.getElementById('status').style.display = 'none';
        }
        
        async function runComparison() {
            const parentFile = document.getElementById('parentFile').files[0];
            const childFile = document.getElementById('childFile').files[0];
            
            if (!parentFile || !childFile) {
                showStatus('Please select both parent and child images', true);
                return;
            }
            
            showStatus('Converting images...');
            
            const parentBase64 = await toBase64(parentFile);
            const childBase64 = await toBase64(childFile);
            
            // Run regular comparison
            showStatus('Running regular face comparison...');
            try {
                const regularResponse = await fetch('/api/rekognition/compare-faces', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sourceImage: parentBase64,
                        targetImage: childBase64,
                        similarityThreshold: 1
                    })
                });
                
                const regularData = await regularResponse.json();
                
                if (regularData.success) {
                    document.getElementById('regularResult').innerHTML = `
                        <div class="similarity-big">${regularData.data.similarity.toFixed(1)}%</div>
                        <p>Simple cosine similarity</p>
                        <p>No feature breakdown</p>
                        <p style="color: #666; font-size: 12px;">Uses general face recognition</p>
                    `;
                } else {
                    document.getElementById('regularResult').innerHTML = `
                        <p style="color: red;">Error: ${regularData.error}</p>
                    `;
                }
            } catch (err) {
                document.getElementById('regularResult').innerHTML = `
                    <p style="color: red;">Failed: ${err.message}</p>
                `;
            }
            
            // Run family similarity analysis
            showStatus('Running family similarity analysis...');
            try {
                const familyResponse = await fetch('/api/family-similarity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parentImage: parentBase64,
                        childImage: childBase64
                    })
                });
                
                const familyData = await familyResponse.json();
                
                if (familyData.success && familyData.data) {
                    const data = familyData.data;
                    let featureHtml = '';
                    
                    if (data.feature_breakdown) {
                        const featureNames = {
                            'eye_region': 'üëÅÔ∏è Eyes',
                            'nose_shape': 'üëÉ Nose',
                            'face_shape': 'üòä Face Shape',
                            'mouth_region': 'üëÑ Mouth'
                        };
                        
                        featureHtml = '<div class="feature-grid">';
                        for (const [feature, score] of Object.entries(data.feature_breakdown)) {
                            featureHtml += `
                                <div class="feature-item">
                                    <div class="feature-name">${featureNames[feature] || feature}</div>
                                    <div class="feature-score">${score.toFixed(1)}%</div>
                                </div>
                            `;
                        }
                        featureHtml += '</div>';
                    }
                    
                    document.getElementById('familyResult').innerHTML = `
                        <div class="similarity-big">${data.family_similarity.toFixed(1)}%</div>
                        <p><strong>${data.similarity_level}</strong></p>
                        ${featureHtml}
                        <p style="color: #666; font-size: 12px;">
                            Base: ${data.base_similarity.toFixed(1)}% | 
                            Age-adjusted: ${data.age_corrected_similarity.toFixed(1)}%
                        </p>
                        <p style="color: #666; font-size: 12px;">
                            Confidence: ${data.confidence.toFixed(1)}%
                        </p>
                    `;
                } else {
                    document.getElementById('familyResult').innerHTML = `
                        <p style="color: red;">Error: ${familyData.error}</p>
                    `;
                }
            } catch (err) {
                document.getElementById('familyResult').innerHTML = `
                    <p style="color: red;">Failed: ${err.message}</p>
                `;
            }
            
            showStatus('‚úÖ Comparison complete!');
        }
    </script>
</body>
</html>